<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <title>Rem Board Stream</title>
        <style>
            /* body {
                background-color: aquamarine;
            } */

            #board {
                /* position: relative; */
                width: 600px;
                height: 600px;

                border: red solid 2px;
            }

            #canvas-board {
                position: absolute;
                background-color: transparent;
                z-index: 2;
            }

            #image-bg {
                position: absolute;
                z-index: 1;
            }
        </style>
    </head>

    <body>
        <h3>Board canvas base demo</h3>
        <p>A simple case of use of a canvas based board.</p>
        <script src="/socket.io/socket.io.js"></script>

        <div id="board">
            <canvas id="canvas-board" width="600px" height="600px"></canvas>
            <img id="streaming" />
            <script>
                (function (d, io) {
                    var io = io();

                    io.on("play stream", function (image) {
                        d.querySelector("#streaming").src = image;
                    });
                })(document, io);
            </script>
        </div>

        <script>
            let globalRemUserID;
            window.onload = () => {
                const ioInstance = io();
                var selectCanvas = document.getElementById("canvas-board");
                const selectedColor = "#dbf55b";

                const remUserID = localStorage.getItem("remUserID");

                if (remUserID && remUserID !== "") globalRemUserID = remUserID;

                // var brushPalette = document.getElementById("brushPalette");
                // selectCanvas.console.log(selectCanvas);

                if (selectCanvas) {
                    const start = (e) => {
                        isDown = true;
                        // [draw start cmd]
                        ioInstance.emit("drawing", { user: globalRemUserID, event: "start" });

                        context.beginPath();
                        canvasX = e.pageX - selectCanvas.offsetLeft;
                        canvasY = e.pageY - selectCanvas.offsetTop;
                        context.moveTo(canvasX, canvasY);

                        // [canvasX0, canvasY0]

                        ioInstance.emit("drawing", {
                            user: globalRemUserID,
                            event: "draw",
                            payload: { x: canvasX, y: canvasY },
                        });

                        // "string template js"
                    };

                    const draw = (e) => {
                        if (isDown) {
                            canvasX = e.pageX - selectCanvas.offsetLeft;
                            canvasY = e.pageY - selectCanvas.offsetTop;
                            context.lineTo(canvasX, canvasY);
                            context.strokeStyle = selectedColor;
                            context.stroke();
                            // [canvasX1, canvasY1, canvasX2, canvasY2, ...]
                            ioInstance.emit("drawing", {
                                user: globalRemUserID,
                                event: "draw",
                                payload: { x: canvasX, y: canvasY },
                            });
                        }
                    };

                    const stop = (e) => {
                        isDown = false;
                        context.closePath();
                        // [draw end cmd]
                        ioInstance.emit("drawing", {
                            user: globalRemUserID,
                            event: "stop",
                        });
                    };

                    selectCanvas.addEventListener("mousedown", start, false);
                    selectCanvas.addEventListener("mouseup", stop, false);
                    selectCanvas.addEventListener("mousemove", draw, false);
                    // brushPalette.addEventListener(
                    //     "click",
                    //     function (e) {
                    //         changeStroke(e, this);
                    //     },
                    //     false
                    // );

                    var isDown = false;
                    var context = selectCanvas.getContext("2d");
                    var canvasX, canvasY;
                    context.lineWidth = 2;

                    // function changeStroke(e, obj) {
                    //     if (e.target.dataset.stroke) {
                    //         var parent = e.target.parentElement.children;
                    //         for (var i in parent) {
                    //             if (parent.hasOwnProperty(i)) {
                    //                 if (e.target.className === parent[i].className) {
                    //                     e.target.style.border = "2px dotted";
                    //                 } else {
                    //                     parent[i].style.border = "none";
                    //                 }
                    //             }
                    //         }
                    //         context.lineWidth = e.target.dataset.stroke;
                    //     }
                    // }

                    //ioInstance.on("drawing", function (data) {
                    //  context.lineTo(data[1], data[2]);
                    // context.strokeStyle = selectedColor;
                    // context.stroke();

                    //})

                    ioInstance.on("register", (data) => {
                        if (globalRemUserID && globalRemUserID !== "") return;

                        localStorage.setItem("remUserID", data);
                        globalRemUserID = data;
                    });

                    ioInstance.on("to-draw", (data) => {
                        console.log(data);
                    });
                }
            };
        </script>
    </body>
</html>
